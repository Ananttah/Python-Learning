<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Spritesheet Generator</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --text-color: #cdd6f4;
            --accent: #89b4fa;
            --panel-bg: #313244;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 { margin-bottom: 10px; }

        .controls {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label { font-size: 0.9rem; font-weight: 600; }

        input[type="file"] {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #45475a;
            color: var(--text-color);
        }

        input[type="number"] {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #45475a;
            background: var(--bg-color);
            color: var(--text-color);
            width: 80px;
        }

        button {
            background-color: var(--accent);
            color: #111;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover { opacity: 0.9; }
        button:disabled { background-color: #555; cursor: not-allowed; }

        /* Checkerboard pattern for transparency */
        .canvas-container {
            border: 2px dashed #45475a;
            border-radius: 4px;
            background-image: linear-gradient(45deg, #2a2a38 25%, transparent 25%), 
                              linear-gradient(-45deg, #2a2a38 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #2a2a38 75%), 
                              linear-gradient(-45deg, transparent 75%, #2a2a38 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #1e1e2e; /* Fallback */
            overflow: auto;
            max-width: 100%;
            max-height: 70vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        canvas {
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            max-width: 100%; /* Responsive scaling for view only */
        }
        
        .status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #a6adc8;
        }
    </style>
</head>
<body>

    <h2>Sprite Sheet Generator</h2>

    <div class="controls">
        <div class="input-group">
            <label for="files">1. Select Sprites</label>
            <input type="file" id="files" multiple accept="image/png, image/jpeg, image/gif">
        </div>

        <div class="input-group">
            <label for="columns">Columns (Frames per row)</label>
            <input type="number" id="columns" value="0" min="0" placeholder="0 = Single Row">
        </div>

        <div class="input-group">
            <label for="padding">Padding (px)</label>
            <input type="number" id="padding" value="0" min="0">
        </div>

        <div class="input-group">
            <label>&nbsp;</label>
            <button id="downloadBtn" disabled>Download PNG</button>
        </div>
    </div>

    <div class="status" id="statusMsg">Waiting for images...</div>

    <div class="canvas-container">
        <canvas id="previewCanvas"></canvas>
    </div>

<script>
    const fileInput = document.getElementById('files');
    const colInput = document.getElementById('columns');
    const padInput = document.getElementById('padding');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusMsg = document.getElementById('statusMsg');

    let loadedImages = [];

    // Helper: Load an image from file object
    const loadImage = (file) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve({ img, name: file.name });
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    };

    // Helper: Natural Sort (so 'walk_2' comes before 'walk_10')
    const naturalSort = (a, b) => {
        return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
    };

    const processImages = async () => {
        if (!fileInput.files.length) return;

        statusMsg.innerText = "Processing...";
        loadedImages = [];
        
        // 1. Load all images
        const promises = Array.from(fileInput.files).map(loadImage);
        
        try {
            const results = await Promise.all(promises);
            // 2. Sort by name
            loadedImages = results.sort(naturalSort);
            drawSpriteSheet();
        } catch (error) {
            console.error(error);
            statusMsg.innerText = "Error loading images.";
        }
    };

    const drawSpriteSheet = () => {
        if (loadedImages.length === 0) return;

        const padding = parseInt(padInput.value) || 0;
        let cols = parseInt(colInput.value) || loadedImages.length; // Default to single row if 0
        if (cols < 1) cols = loadedImages.length; // Safety fallback

        // Calculate dimensions
        // Note: We assume sprites *might* vary in size, so we calculate cell size based on the largest sprite
        let maxW = 0;
        let maxH = 0;

        loadedImages.forEach(item => {
            if (item.img.width > maxW) maxW = item.img.width;
            if (item.img.height > maxH) maxH = item.img.height;
        });

        const rows = Math.ceil(loadedImages.length / cols);
        
        const canvasWidth = (cols * maxW) + ((cols - 1) * padding);
        const canvasHeight = (rows * maxH) + ((rows - 1) * padding);

        // Resize canvas
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        
        // Clear canvas (transparency)
        ctx.clearRect(0, 0, canvasWidth, canvasHeight);

        // Draw images
        loadedImages.forEach((item, index) => {
            const colIndex = index % cols;
            const rowIndex = Math.floor(index / cols);

            const x = colIndex * (maxW + padding);
            const y = rowIndex * (maxH + padding);

            // Center image in the "cell" if it's smaller than maxW/maxH
            const offsetX = (maxW - item.img.width) / 2;
            const offsetY = (maxH - item.img.height) / 2;

            ctx.drawImage(item.img, x + offsetX, y + offsetY);
        });

        statusMsg.innerText = `Generated: ${canvasWidth}x${canvasHeight}px | ${loadedImages.length} Sprites`;
        downloadBtn.disabled = false;
    };

    // Download Handler
    downloadBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'spritesheet.png';
        // toDataURL defaults to PNG at 96dpi, preserving quality
        link.href = canvas.toDataURL('image/png');
        link.click();
    });

    // Event Listeners for live updates
    fileInput.addEventListener('change', processImages);
    colInput.addEventListener('input', drawSpriteSheet);
    padInput.addEventListener('input', drawSpriteSheet);

</script>
</body>
</html>